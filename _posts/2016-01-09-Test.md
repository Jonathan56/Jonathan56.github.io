---
layout: post
title: "Uncontrolled-charging-car-model"
tags:
    - python
    - notebook
---
**In [1]:**

{% highlight python %}
from __future__ import division

# General imports
import os
import sys
import numpy as np
from IPython.display import clear_output

# Import V2G-Sim
v2gSimPath = os.path.join(os.getcwd(), "../../v2g_sim")
sys.path.append(os.path.join(v2gSimPath))
import core
import model
import itinerary.load
import result.vehicle_consumption as resultModule

# Imports useful for graphics
import matplotlib.pyplot as plt
import seaborn
seaborn.set_style("whitegrid")
seaborn.despine()
%matplotlib inline
%config InlineBackend.figure_formats = {'svg',}
{% endhighlight %}
 
## V2G-Sim import itineraries 

**In [2]:**

{% highlight python %}
# Initialize location and vehicles from excel file
excelFilename = os.path.join(v2gSimPath, os.path.join("../data/NHTS_data/Tennessee.xlsx"))
vehicleList, locationList = itinerary.load.excel(excelFilename)

clear_output()
{% endhighlight %}
 
## Define functions to create a range of car models 

**In [3]:**

{% highlight python %}
# Define a function that update all vehicle with a new car model
def set_car_model_all_vehicles(vehicleList, carModel):
    for vehicle in vehicleList:
        vehicle.carModel = carModel

# Define a function that update all vehicle with one of the car model
def set_fleet_mix(vehicleList, carModelList, percentageList):
    # Determine how many vehicles for each model
    
    # Randomly pick and remove vehicle from the pool to set their car model
    return None
        
# Define a function to save the result we need
def save_result_and_reset(resultList, vehicleList, carModel, powerDemand):
    # Save power consumption
    resultList.append({'totalConsumption': powerDemand['Total'], 'carModel': carModel})
    resultList[-1]['totalConsumption'] = [resultList[-1]['totalConsumption'][i] / (1000*1000)  # From W to MW
                                          for i in range(0, len(resultList[-1]['totalConsumption']))]
    
    # Save avaerage SOC
    resultList[-1]['averageSOC'] = resultModule.get_average_SOC(vehicleList)
    
    # Save stranded through the day
    resultList[-1]['stranded'] = []
    for vehicle in vehicleList:
        if vehicle.strandingLog:
            resultList[-1]['stranded'].append(vehicle.strandingLog[0])
    
    # Reset the vehicle list
    resultModule.reset_vehicle(vehicleList)
    
    return resultList
{% endhighlight %}
 
## Create a bunch of car model 

**In [4]:**

{% highlight python %}
# Set parameters for the model to generate
d = model.SimpleCarModel("default Leaf")
carModelList = [d]

# Set consumption
for percent in [0.2, -0.2]:
    carModelList.append(model.SimpleCarModel(name="Leaf " + str(percent * 100) + " % " + str(d.batteryCap) + ' Wh',
                                             Delhi=d.Delhi + percent * d.Delhi,
                                             UDDS=d.UDDS + percent * d.UDDS, 
                                             HWFET=d.HWFET + percent * d.HWFET,
                                             US06=d.US06 + percent * d.US06,
                                             batteryCap=d.batteryCap))
# Set battery capacity
for percent in [0.2, -0.2]:
    carModelList.append(model.SimpleCarModel(name="Leaf " + "default " + 
                                             str(d.batteryCap + percent * d.batteryCap) + ' Wh',
                                             Delhi=d.Delhi,
                                             UDDS=d.UDDS, 
                                             HWFET=d.HWFET,
                                             US06=d.US06,
                                             batteryCap=d.batteryCap + percent * d.batteryCap))

# # Set battery capacity
# for percent in [0.2, -0.2]:
#     carModelList.append(model.SimpleCarModel(name="Leaf " + str(percent * 100) + " % " + 
#                                              str(d.batteryCap + percent * d.batteryCap) + ' Wh',
#                                              Delhi=d.Delhi + percent * d.Delhi,
#                                              UDDS=d.UDDS + percent * d.UDDS, 
#                                              HWFET=d.HWFET + percent * d.HWFET,
#                                              US06=d.US06 + percent * d.US06,
#                                              batteryCap=d.batteryCap + percent * d.batteryCap))
{% endhighlight %}
 
## Launch simulations 

**In [5]:**

{% highlight python %}
resultList = []
for index, carModel in enumerate(carModelList):
    print('Simulation number ' + str(index) + ' on ' + str(len(carModelList)) + ' simulations' )
    
    # Change car model and run V2G-Sim
    set_car_model_all_vehicles(vehicleList, carModel)
    powerDemand = core.runV2GSim_reduce(vehicleList, nbIteration=3)
    
    # Save result and reset for next iteration
    resultList = save_result_and_reset(resultList, vehicleList, carModel, powerDemand)
    clear_output()

{% endhighlight %}
 
## Plot results 
 
### 1) Total consumption for all simulations 

**In [6]:**

{% highlight python %}
# Plot the deviation energy domain
plt.figure(figsize=(12, 8), dpi=80)
hourlySteps = 3600 / vehicleList[0].outputInterval
for result in resultList:
    # Create the x axis data
    x = range(0, len(result['totalConsumption']))
    x = [x[i] / hourlySteps for i in range(0, len(x))]
    # Plot the data
    plt.plot(x, result['totalConsumption'], label=result['carModel'].name, linewidth=1)
plt.xlabel('Time of the day (hours)', fontsize=12)
plt.ylabel('Power consumption (MW)', fontsize=12)
plt.title('Total consumption for ' + str(len(vehicleList)) + ' vehicles')
plt.legend()

plt.show()
{% endhighlight %}

 
![svg]({{ site.url }}/assets/image/uncontrolled-charging-car-model_11_0.svg) 

 
### 2) Consumption difference between 2 simulations 

**In [7]:**

{% highlight python %}
plt.figure(figsize=(12, 8), dpi=80)
hourlySteps = 3600 / vehicleList[0].outputInterval

# Plot difference between simulations (sim1 - sim2):
index1 = 3
index2 = 4
consumptionDiff = [resultList[index1]['totalConsumption'][i] - resultList[index2]['totalConsumption'][i]
                  for i in range(0, len(resultList[index1]['totalConsumption']))]
x = range(0, len(consumptionDiff))
x = [x[i] / hourlySteps for i in range(0, len(x))]

# Plot the data
plt.plot(x, consumptionDiff, linewidth=2)
plt.xlabel('Time of the day (hours)', fontsize=12)
plt.ylabel('Power consumption (MW)', fontsize=12)
plt.title('Difference of consumption between ' + 
          resultList[index1]['carModel'].name + ' and ' + 
          resultList[index2]['carModel'].name)

plt.show()
{% endhighlight %}

 
![svg]({{ site.url }}/assets/image/uncontrolled-charging-car-model_13_0.svg) 

 
### 3) Average SOC for all simulations 

**In [8]:**

{% highlight python %}
# Plot the deviation energy domain
plt.figure(figsize=(12, 8), dpi=80)
hourlySteps = 3600 / vehicleList[0].outputInterval
for result in resultList:
    # Create the x axis data
    x = range(0, len(result['averageSOC']))
    x = [x[i] / hourlySteps for i in range(0, len(x))]
    # Plot the data
    plt.plot(x, result['averageSOC'], label=result['carModel'].name, linewidth=1.3)
plt.xlabel('Time of the day (hours)', fontsize=12)
plt.ylabel('SOC (%)', fontsize=12)
plt.title('Average SOC for ' + str(len(vehicleList)) + ' vehicles')
plt.legend()

plt.show()
{% endhighlight %}

 
![svg]({{ site.url }}/assets/image/uncontrolled-charging-car-model_15_0.svg) 

 
### 4) Stranding vehicles throught the day for all simulations 

**In [9]:**

{% highlight python %}
plt.figure(figsize=(12, 8), dpi=80)
x = []
legend = []
for index, result in enumerate(resultList):
    x.append(result['stranded'])
    legend.append(result['carModel'].name)
    print('For simulation with ' + result['carModel'].name + ' there are ' + str(len(result['stranded'])) + 
         ' vehicles that could not make it (' + '{:.2f}'.format(len(result['stranded']) * 100 / len(vehicleList)) + '%).')

plt.hist(x, 12)
plt.xlabel('Time of the day (hours)', fontsize=12)
plt.ylabel('Number of stranded', fontsize=12)
plt.title('Stranded repartition throught out the day')
plt.legend(legend)
plt.show()
{% endhighlight %}

    For simulation with default Leaf there are 182 vehicles that could not make it (8.71%).
    For simulation with Leaf 20.0 % 23832 Wh there are 250 vehicles that could not make it (11.96%).
    For simulation with Leaf -20.0 % 23832 Wh there are 129 vehicles that could not make it (6.17%).
    For simulation with Leaf default 28598.4 Wh there are 148 vehicles that could not make it (7.08%).
    For simulation with Leaf default 19065.6 Wh there are 254 vehicles that could not make it (12.15%).


 
![svg]({{ site.url }}/assets/image/uncontrolled-charging-car-model_17_1.svg) 


**In [None]:**

{% highlight python %}

{% endhighlight %}
